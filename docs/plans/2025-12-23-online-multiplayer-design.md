# 線上對戰功能設計文檔

**日期:** 2025-12-23
**版本:** 1.0
**狀態:** 已批准

## 概述

為井字遊戲新增線上多人對戰功能,讓玩家可以透過網路與朋友或隨機對手進行即時對戰。

## 目標

- 在現有遊戲基礎上新增線上對戰模式
- 支援房間代碼配對和隨機配對兩種方式
- 使用匿名暱稱系統,無需註冊登入
- 提供流暢的分享與加入體驗
- 處理斷線情況,確保遊戲公平性

## 技術架構

### 後端服務

**Firebase Realtime Database**
- 儲存遊戲房間、玩家狀態、棋盤狀態等即時數據
- 提供即時同步功能
- 免費額度足夠小型專案使用

**部署方式**
- 前端繼續使用 GitHub Pages
- 不需要額外的伺服器部署

### 數據結構

```javascript
/rooms
  /{roomId}                          // 唯一房間 ID (UUID)
    - roomCode: "A2B5"               // 4 位數房間代碼
    - status: "waiting"              // waiting | playing | finished
    - createdAt: timestamp           // 房間創建時間
    - lastActivity: timestamp        // 最後活動時間
    - mode: "private"                // private(房間代碼) | random(隨機配對)
    - players
      - player1
        - id: "uuid"                 // 玩家唯一 ID
        - nickname: "玩家A"          // 暱稱
        - symbol: "X"                // X 或 O
        - connected: true            // 連線狀態
        - lastSeen: timestamp        // 最後在線時間
      - player2
        - id: "uuid"
        - nickname: "玩家B"
        - symbol: "O"
        - connected: true
        - lastSeen: timestamp
    - gameState
      - board: ["", "", "", ...]     // 9 個格子的狀態
      - currentTurn: "player1"       // player1 | player2
      - winner: null                 // null | "player1" | "player2" | "draw"
      - winningLine: null            // [0, 1, 2] 或 null
```

## 使用者流程

### 房間代碼配對流程

**創建房間:**
1. 玩家在模式選擇畫面點擊「線上對戰」
2. 選擇「創建房間」
3. 輸入暱稱(最多 12 個字元)
4. 系統生成 4 位數房間代碼並創建房間
5. 顯示等待畫面:
   - 顯示房間代碼(大字體)
   - 提供「複製連結」按鈕
   - 連結格式: `https://justin1byte.github.io/game-tic-tac-toe/?room=A2B5`
6. 等待第二位玩家加入

**加入房間:**
1. 玩家在模式選擇畫面點擊「線上對戰」
2. 選擇「加入房間」
3. 輸入暱稱
4. 輸入 4 位數房間代碼(或透過 URL 參數自動填入)
5. 驗證房間存在且可加入
6. 加入成功後雙方同時進入遊戲

### 隨機配對流程

1. 玩家在模式選擇畫面點擊「線上對戰」
2. 選擇「隨機配對」
3. 輸入暱稱
4. 系統搜尋等待中的隨機配對房間:
   - 如果找到 → 加入該房間
   - 如果沒找到 → 創建新的隨機配對房間並等待
5. 顯示「尋找對手中...」動畫
6. 配對成功後雙方同時進入遊戲

### 遊戲進行流程

1. 房主(player1)固定使用 X,客人(player2)固定使用 O
2. X 先手(房主先下)
3. 玩家只能在輪到自己時下棋
4. 每次落子同步到 Firebase
5. 對手的棋盤即時更新
6. 遊戲結束時顯示結果
7. 提供「再玩一局」和「返回選單」選項

## 斷線處理機制

### 心跳檢測 (Heartbeat)

- 每位玩家每 5 秒更新一次 `lastSeen` 時間戳記
- 系統監聽對手的 `lastSeen`
- 如果超過 15 秒未更新 → 判定為斷線

### 斷線處理流程

1. 偵測到對手斷線 → 顯示「對手已斷線,等待重新連線...」
2. 開始 30 秒倒數計時,顯示剩餘時間
3. 如果 30 秒內對手重新連線 → 繼續遊戲
4. 如果 30 秒後仍未連線 → 判定連線中的玩家獲勝
5. 如果自己斷線後重新連線 → 自動回到原本的遊戲房間(如果還在 30 秒內)

## 房間管理

### 房間代碼生成規則

- 使用大寫英文字母(A-Z)和數字(0-9)組合
- 排除容易混淆的字元:0/O, 1/I/L
- 4 位數組合,例如:"A2B5", "K9M3", "P7Q4"
- 確保代碼唯一性(生成後檢查是否已存在)

### 自動清理規則

- 遊戲結束後 5 分鐘自動刪除房間
- 等待中但超過 10 分鐘無活動的房間自動刪除
- 雙方都斷線的房間立即刪除

### 玩家主動離開

點擊「返回選單」時:
- 如果在等待中 → 直接刪除房間
- 如果在遊戲中 → 判定對手獲勝並結束遊戲

## UI 介面設計

### 新增畫面列表

1. **線上對戰模式選擇畫面**
   - 標題:「線上對戰」
   - 按鈕:「創建房間」、「加入房間」、「隨機配對」
   - 「返回」按鈕

2. **暱稱輸入畫面**
   - 輸入框:暱稱(最多 12 個字元)
   - 提示:「請輸入你的暱稱」
   - 「確認」和「返回」按鈕

3. **創建房間等待畫面**
   - 文字:「等待對手加入...」
   - 房間代碼:大字體顯示
   - 「複製連結」按鈕(點擊後顯示「已複製!」)
   - 「取消」按鈕

4. **加入房間輸入畫面**
   - 輸入框:4 位數房間代碼
   - 「加入」和「返回」按鈕

5. **隨機配對等待畫面**
   - 動畫:「尋找對手中...」
   - 「取消」按鈕

6. **線上遊戲畫面(基於現有遊戲畫面)**
   - 顯示雙方暱稱
   - 連線狀態指示器(綠點 = 連線,紅點 = 斷線)
   - 斷線倒數計時器(當對手斷線時)
   - 輪到誰的提示(只能在自己回合下棋)

### 視覺設計一致性

- 保持復古風格:米色背景、深棕色邊框
- 字體:Courier New, monospace
- 按鈕樣式與現有設計一致
- 房間代碼使用較大且醒目的字體
- 連線狀態使用簡單的圓點圖示
- 倒數計時器使用醒目的紅色

## 錯誤處理

### 錯誤情況與提示訊息

| 錯誤情況 | 提示訊息 |
|---------|---------|
| 房間不存在 | 「房間代碼錯誤或房間已關閉」 |
| 房間已滿 | 「房間已滿,無法加入」 |
| 房間已開始 | 「遊戲已開始,無法加入」 |
| 網路連線失敗 | 「網路連線失敗,請檢查網路」 |
| 暱稱為空 | 「請輸入暱稱」 |
| 房間代碼格式錯誤 | 「請輸入 4 位數房間代碼」 |
| Firebase 配置錯誤 | 「伺服器連線失敗,請稍後再試」 |

## 實作優先順序

### Phase 1: 基礎架構
1. 設定 Firebase 專案
2. 整合 Firebase SDK
3. 實作基本數據結構
4. 實作房間創建與加入邏輯

### Phase 2: 核心功能
1. 實作房間代碼配對
2. 實作遊戲狀態同步
3. 實作基本 UI 畫面
4. 實作分享連結功能

### Phase 3: 進階功能
1. 實作隨機配對
2. 實作斷線偵測與處理
3. 實作心跳檢測
4. 實作房間自動清理

### Phase 4: 優化與測試
1. 錯誤處理完善
2. UI/UX 優化
3. 多裝置測試
4. 效能優化

## 技術考量

### 安全性
- 使用 Firebase Security Rules 限制數據存取
- 驗證房間代碼格式
- 限制暱稱長度和內容

### 效能
- 使用 Firebase 的即時監聽功能,避免輪詢
- 離開房間時解除所有監聽器
- 及時清理無用房間,減少數據庫負擔

### 相容性
- 支援現代瀏覽器(Chrome, Firefox, Safari, Edge)
- 響應式設計,支援手機和桌面裝置
- 處理不同網路環境(Wi-Fi, 4G/5G)

## 成功指標

- 玩家能在 30 秒內成功創建房間並分享連結
- 玩家能在 10 秒內透過連結加入房間
- 遊戲同步延遲小於 1 秒
- 斷線重連成功率 > 90%
- 錯誤提示清晰易懂

## 未來擴展可能性

- 加入好友系統
- 遊戲歷史記錄
- 對戰統計與排行榜
- 聊天功能
- 自訂遊戲設定(例如誰先手)
- 觀戰模式
